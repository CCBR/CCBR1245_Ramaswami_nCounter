---
title: "nCounter_RNA_Analysis"
author: "Ned Cauley"
date: "12/13/23"
output: html_document
---

# This markdown and analysis based on https://github.com/bhattacharya-a-bt/CBCS_normalization/blob/master/sabry_analysis.R
# The above analysis is form the publication https://academic.oup.com/bib/article/22/3/bbaa163/5891144?login=true

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
```

## Set up libraries and QC functions libraries

```{r Libraries and RUVseq functions, message=FALSE, warning=FALSE}
library(NanoStringQCPro)
library(ggplot2)
library(EnvStats)
library(MASS)
library(RUVSeq)
library(DESeq2)
library(limma)
library(matrixStats)
library(limma)
library(NanoStringNorm)
library(readxl)

# The library in RSW to use is located at
# /home/cauleyes/ccbr-data/renv_cache/ncounter_rna/Snapshot-environment_method/renv/library/R-4.1/x86_64-pc-linux-gnu

# Set the working directory to your project folder if it is not set already
setwd("/home/cauleyes/ccbr-data/users/Ned/nCounter_rna/CCBR1245_Ramaswami_nCounter")

# Functions for RUVseq analysis
source("R/nanostring_RUV_functions.R")

# Load the annotation file
annotation_file_path <- "ncounter_rna_annotation_edit.xlsx"
annotation_df <- read_excel(annotation_file_path)

```

```{r Define the contrast for the DEG analysis, message=FALSE, warning=FALSE}

# Define the contrast and levels from the annotation columns for QC and DEG analysis
contrast <- "CD4_group"
#contrast <- "KS_alone"

contrast_levels <- c("High", "Low")
#contrast_levels <- c("Y", "N")

```


## Setup the initial dataframes with read counts and metadata/QC

```{r Initial Dataframes and QC,  message=FALSE, warning=FALSE}
# Gather the names of the RCC files
files.RCC = list.files("/rstudio-files/ccbr-data/users/Ned/nCounter_rna/data/CCBR1245/rcc")
files.RCC = files.RCC[grepl('RCC',files.RCC)]
# Add name of sub folder containing RCC files
rcc_folder <- "/rstudio-files/ccbr-data/users/Ned/nCounter_rna/data/CCBR1245/rcc"
files.RCC <- file.path(rcc_folder, files.RCC)

# Gather number of genes and samples
genes.count = nrow(readRcc(files.RCC[1])$Code_Summary)
ncol = length(files.RCC)

# Set up the dataframe to hold all sample and gene data
raw_expression = as.data.frame(matrix(nrow = genes.count,ncol = length(files.RCC)+2))
colnames(raw_expression)[1:2] = c('Gene','Class')

# Set up a dataframe to hold metadata and QC
pData = as.data.frame(matrix(nrow = length(files.RCC),ncol = 11))
colnames(pData) = c('BCAC_ID','SampleID','Owner','Comments','Date','GeneRLF','SystemAPF','imagingQC',
                    'bindingDensityQC','limitOfDetectionQC','positiveLinearityQC')

# Populate gene and class columns of expression df
raw_expression[,1:2] = readRcc(files.RCC[1])$Code_Summary[,c(2,1)]

print("RCC files to be processed:")
# Populate expression df, run QC, and record flags for each sample
for (i in 1:length(files.RCC)){
  
  print(files.RCC[i])
  rcc = readRcc(files.RCC[i])
  raw = rcc$Code_Summary
  
  raw_expression[,i+2] = as.numeric(raw$Count)
  colnames(raw_expression)[i+2] = strsplit(files.RCC[i],'_')[[1]][1]
  pData[i,2:7] = as.vector(rcc$Sample_Attributes)
  pData$imagingQC[i] = imagingQC(rcc)
  pData$bindingDensityQC[i] = bindingDensityQC(rcc,.05,2.25)
  pData$limitOfDetectionQC[i] = limitOfDetectionQC(rcc)
  pData$positiveLinearityQC[i] = positiveLinQC(rcc)
  
}

# Correct the sample ID column name and sample name IDs
# Correct for annotation
colnames(annotation_df)[4] <- "SampleID"
annotation_df$"SampleID" <- gsub("-", " ", annotation_df$"SampleID")
# Correct for pdata
annotation_df$"SampleID" <- gsub("-", " ", annotation_df$"SampleID")
annotation_df$"SampleID" <- gsub("\\sSB", "SB", annotation_df$"SampleID")
pData$"SampleID" <- gsub("-", " ", pData$"SampleID")
pData$"SampleID" <- gsub("\\sSB", "SB", pData$"SampleID")

# Rename and factor the KS alone field and sort by Yes or No
colnames(annotation_df)[colnames(annotation_df) == "KS alone"] <- "KS_alone"
colnames(annotation_df)[colnames(annotation_df) == "CD4 count...9"] <- "CD4_group"

# Combine all metadata into a single dataframe
merged_pData <- merge(pData, annotation_df, by = "SampleID")

#merged_pData$KS_alone <- factor(merged_pData$'KS_alone', levels = c("Y", "N"))
#merged_pData$CD4_group <- factor(merged_pData$'CD4_group', levels = c("High", "Low"))
merged_pData[[contrast]] <- factor(merged_pData[[contrast]], levels = contrast_levels)

# Create a feature df
raw = raw_expression[,-c(1:2)]
fData = raw_expression[,c(1:2)]
rownames(raw) = fData$Gene
# List the housekeeping genes and label in the fData df
cIdx <- fData$Gene[fData$Class == "Housekeeping"]
merged_pData$HK_Gene_Miss = colSums(raw[cIdx,] == 0)

# Sync all of the rownames of the three dfs
rownames(fData) = fData$Gene
rownames(raw) = fData$Gene
rownames(merged_pData) = colnames(raw)

print("Initial data frames")
head(raw_expression)
head(pData)
head(fData)

```

## Verify that housekeeping genes are not DEGs

```{r, message=FALSE, warning=FALSE}
###
#### CHECK IF HK ARE ASSOCIATED WITH PRIMARY PHENO
###

# Gather the read counts for housekeeping genes
hk_raw = raw[cIdx,]
pval = vector(length = nrow(hk_raw))

# Run general linear model to get pvalue for housekeeping
for (i in 1:nrow(hk_raw)){
  
  #reg = glm.nb(as.numeric(hk_raw[i,]) ~ as.factor(merged_pData$KS_alone))
  #reg = glm.nb(as.numeric(hk_raw[i,]) ~ as.factor(merged_pData$CD4_group))
  reg = glm.nb(as.numeric(hk_raw[i,]) ~ as.factor(merged_pData[[contrast]]))
  pval[i] = coef(summary(reg))[2,4]
  
}

print("Housekeeping genes:")
print(rownames(hk_raw))

# Number of housekeeping that are DE
print("Number of housekeeping genes that are DE:")
sum(pval <= .05)

```

## Run RUVseq differential expression analysis

```{r, message=FALSE, warning=FALSE}
k = 1
# DEseq transform for RUVseq
vsd = RUV_total(raw,merged_pData,fData,k = k)$vsd
# Set Expression Set
set = RUV_total(raw,merged_pData,fData,k = k)$set

# Save the results
save(vsd,file = paste0("cauley_ruv_vsd_k_",k,".rda"))
save(set,file = paste0("cauley_ruv_set_k_",k,".rda"))


i = 1

results = paste0("cauley_deg_k",i,".csv")
load(paste0("cauley_ruv_set_k_",i,".rda"))
# DEseq Dataset
#dds <- DESeqDataSetFromMatrix(countData = counts(set)[1:nrow(set),],
                              #colData = pData(set),
                              #design = ~ W_1 + KS_alone)

#dds <- DESeqDataSetFromMatrix(countData = counts(set)[1:nrow(set),],
                              #colData = pData(set),
                              #design = ~ W_1 + CD4_group)

dds <- DESeqDataSetFromMatrix(countData = counts(set)[1:nrow(set),],
                              colData = pData(set),
                              design = as.formula(paste("~ W_1 +", contrast)))

# Run DEseq
dds <- DESeq(dds)

# Generate contrasts per group
#ks_alone_ruv <- as.data.frame(results(dds,contrast = c('KS_alone','Y','N')))
#contrast_ruv <- as.data.frame(results(dds,contrast = c('CD4_group','High','Low')))
contrast_ruv <- as.data.frame(results(dds,contrast = c(contrast, contrast_levels)))

contrast_ruv_deg_list <- contrast_ruv[contrast_ruv$pvalue < 0.05, ]

# Reformat the DEG table to be exported
ruv_deg_list_export <- contrast_ruv_deg_list
ruv_deg_list_export$gene <- rownames(ruv_deg_list_export)
rownames(ruv_deg_list_export) <- NULL
ruv_deg_list_export <- ruv_deg_list_export[, c("gene", setdiff(names(ruv_deg_list_export), "gene"))]
ruv_deg_list_export$normalization <- "RUVseq"
```

## Run nSolver differential expression analysis 


```{r, message=FALSE, warning=FALSE}
# Set up the DEseq matrix for nsolver
#dds.nsolver <- DESeqDataSetFromMatrix(countData = counts(set)[1:nrow(set),],
#                                      colData = pData(set),
#                                      design = ~KS_alone)

#dds.nsolver <- DESeqDataSetFromMatrix(countData = counts(set)[1:nrow(set),],
                                      #colData = pData(set),
                                      #design = ~CD4_group)

dds.nsolver <- DESeqDataSetFromMatrix(countData = counts(set)[1:nrow(set),],
                                      colData = pData(set),
                                      as.formula(paste("~", contrast)))

pos = raw[grepl('POS',rownames(raw)),]

# Housekeeping genes expression
hk = raw[grepl('Housekeeping',raw_expression$Class),]

# Set up nSolver
pos.factors = mean(as.numeric(apply(pos,2,geoMean)))/as.numeric(apply(pos,2,geoMean))
hk.factors = mean(as.numeric(apply(hk,2,geoMean)))/as.numeric(apply(hk,2,geoMean))
sizeFactors(dds.nsolver) <- pos.factors * hk.factors

# Run DEseq
dds.nsolver <- DESeq(dds.nsolver)

# Generate contrasts for each group for nSolver analysis

#ks_alone_nsolver <- as.data.frame(results(dds.nsolver,contrast = c('KS_alone','Y','N')))
#contrast_nsolver <- as.data.frame(results(dds.nsolver,contrast = c('CD4_group','High','Low')))
contrast_nsolver <- as.data.frame(results(dds.nsolver,contrast = c(contrast,contrast_levels)))

#ks_alone_nsolver_deg_list <- ks_alone_nsolver[ks_alone_nsolver$pvalue < 0.05, ]
contrast_nsolver_deg_list <- contrast_nsolver[contrast_nsolver$pvalue < 0.05, ]

# Reformat the DEG table to be exported
nsolver_deg_list_export <- contrast_nsolver_deg_list
nsolver_deg_list_export$gene <- rownames(nsolver_deg_list_export)
rownames(nsolver_deg_list_export) <- NULL
nsolver_deg_list_export <- nsolver_deg_list_export[, c("gene", setdiff(names(nsolver_deg_list_export), "gene"))]
nsolver_deg_list_export$normalization <- "nCounter"


# Overlapping genes between the methods

#ks_alone_nsolver_deg_genes <- rownames(ks_alone_nsolver_deg_list)
#ks_alone_ruv_deg_genes <- rownames(ks_alone_ruv_deg_list)
#shared_gene_list <- intersect(ks_alone_nsolver_deg_genes, ks_alone_ruv_deg_genes)

contrast_nsolver_deg_genes <- rownames(contrast_nsolver_deg_list)
contrast_ruv_deg_genes <- rownames(contrast_ruv_deg_list)
shared_gene_list <- intersect(contrast_nsolver_deg_genes, contrast_ruv_deg_genes)

# Create the total DEG list from each norm type for export

combined_DEG_list_export <- rbind(ruv_deg_list_export, nsolver_deg_list_export)

# Write out the DEG list, if desired
export_DEG_list <- TRUE
if(export_DEG_list == TRUE){
  write.csv(combined_DEG_list_export, file = paste0("Results/DEG/DEG_list_",contrast,".csv"), row.names = FALSE)
}

```

# Create the plot for comparing RUVseq vs. nSolver p-values

```{r pvalue_ruvseq_v_nsolver, message=FALSE, warning=FALSE}

# Create comparison plots between RUVseq and nSolver analysis
#pval.plot.ks_alone = data.frame(Method = rep(c('nSolver','RUVSeq'),each = nrow(ks_alone_ruv)),
#                           P = c(ks_alone_nsolver$pvalue,ks_alone_ruv$pvalue))

pval.plot.contrast = data.frame(Method = rep(c('nSolver','RUVSeq'),each = nrow(contrast_ruv)),
                           P = c(contrast_nsolver$pvalue,contrast_ruv$pvalue))

#pval.plot.ks_alone$Contrast = 'KS_alone'
#pval.plot.contrast$Contrast = 'CD4_group'
pval.plot.contrast$Contrast = contrast

#pval.plot.ks_alone$Contrast = as.factor(pval.plot.ks_alone$Contrast)
pval.plot.contrast$Contrast = as.factor(pval.plot.contrast$Contrast)

pvals = ggplot(data = pval.plot.contrast,
               aes(x = P,color = Method,
                   fill = Method)) + geom_histogram(alpha = .2) +
  facet_wrap(~Contrast) + theme_minimal() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=24),
        plot.title = element_text(size = 30),
        legend.title=element_text(size=20),
        legend.text=element_text(size=20),
        strip.text = element_text(size=24),
        panel.spacing=unit(1, "lines"),
        panel.border = element_rect(color = "grey", 
                                    fill = NA, size = .1),
        legend.position = 'bottom') +
  scale_color_manual(values = c("#377EB8","#E41A1C","#4DAF4A")) + 
  scale_fill_manual(values = c("#377EB8","#E41A1C","#4DAF4A")) +
  ylab('Count')

print(pvals)

# Export the plot, if desired
export_pval_plot <- TRUE
if(export_pval_plot == TRUE){
  ggsave(paste0("Results/QC/pval_plot_",contrast,".pdf"), plot = pvals)
}

```

## Set up boxplots for comparing counts

```{r, message=FALSE, warning=FALSE}
#### IL2
# Create RUVseq vs. nSolver comparison plot for IL2

# Gather stat sig DEGs from each method
contrast_ruv_degs = subset(contrast_ruv,pvalue < 0.05)
contrast_nsolver_degs = subset(contrast_nsolver,pvalue < 0.05)
nrow(contrast_ruv_degs)
nrow(contrast_nsolver_degs)

# Overlapping DEGs
length(intersect(rownames(contrast_ruv_degs),rownames(contrast_nsolver_degs)))
degs.both = intersect(rownames(contrast_ruv_degs),rownames(contrast_nsolver_degs))

# Label DEGS from each method
contrast_ruv_degs_unique = rownames(contrast_ruv_degs)[!(rownames(contrast_ruv_degs) %in% degs.both)]
contrast_nsolver_degs_unique = rownames(contrast_nsolver_degs)[!(row.names(contrast_nsolver_degs) %in% degs.both)]

# Set up matrix for il2 comparison boxplot 
boxplot.df = data.frame(Method = c(rep('Both',length(degs.both)),
                                       rep('RUVSeq',length(contrast_ruv_degs_unique)),
                                       rep('nSolver',length(contrast_nsolver_degs_unique))),
                            Median = c(rowMedians(as.matrix(log2(raw[rownames(raw) %in% degs.both,]+1))),
                                       rowMedians(as.matrix(log2(raw[rownames(raw) %in% contrast_ruv_degs_unique,]+1))),
                                       rowMedians(as.matrix(log2(raw[rownames(raw) %in% contrast_nsolver_degs_unique,]+1)))))
#boxplot.df$Contrast = 'KS_alone'
#boxplot.df$Contrast = 'CD4_group'
boxplot.df$Contrast = contrast

# Run Nanostring normalization 
colnames(raw_expression)[1:2] = c('Name','Code.Class')
NanoString.mRNA.norm <- NanoStringNorm(
  x = raw_expression,
  anno = NA,
  CodeCount = 'sum',
  Background = 'none',
  SampleContent = 'housekeeping.sum',
  round.values = FALSE,
  take.log = TRUE,
  return.matrix.of.endogenous.probes = TRUE
)

boxplot.df$Contrast = as.factor(boxplot.df$Contrast)

```

## Create the boxplot for count comparison

```{r compare_counts_boxplot, message=FALSE, warning=FALSE}

# Create boxplot
boxplot = ggplot(data = boxplot.df,
                 aes(x = Method,
                     y = Median)) + geom_boxplot() + 
  geom_jitter(shape=16, position=position_jitter(0.2)) +
  theme_minimal() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=24),
        plot.title = element_text(size = 30),
        legend.title=element_text(size=20),
        legend.text=element_text(size=20),
        strip.text = element_text(size=24),
        panel.spacing=unit(1, "lines"),
        panel.border = element_rect(color = "grey", 
                                    fill = NA, size = .1),
        legend.position = 'bottom') + ylab('Median raw log-counts') + facet_wrap(~Contrast)

print(boxplot)

# Export the plot, if desired
export_boxplot_plot <- TRUE
if(export_boxplot_plot == TRUE){
  ggsave(paste0("Results/QC/boxplot_plot_",contrast,".pdf"), plot = boxplot)
}

```

# Set up the plot to compare log fold change

```{r, message=FALSE, warning=FALSE}

# Set up dot plot

# Gather genes for each method and overlapping genes
#res_il2.plot = subset(res_il2,rownames(res_il2) %in% c(il2.both,rownames(il2.nsolver),
#                                                       rownames(il2.ruv)))

contrast.plot = subset(contrast_ruv,rownames(contrast_ruv) %in% c(degs.both,rownames(contrast_nsolver_degs),
                                                       rownames(contrast_ruv_degs)))

contrast.nsolver.plot = subset(contrast_nsolver,
                              rownames(contrast_ruv) %in% 
                                c(degs.both,rownames(contrast_nsolver_degs),rownames(contrast_ruv_degs)))

# Matrix of fold change per method
contrast.plot.tot = data.frame(Gene = rownames(contrast.plot),
                              nSolverFC = contrast.nsolver.plot$log2FoldChange,
                              nSolverSE = contrast.nsolver.plot$lfcSE,
                              RUVFC = contrast.plot$log2FoldChange,
                              RUVSE = contrast.plot$lfcSE)

# Label fold change matrix
contrast.plot.tot$Method = ifelse(contrast.plot.tot$Gene %in% degs.both,'Both',
                                 ifelse(contrast.plot.tot$Gene %in% rownames(contrast_nsolver),
                                        'nSolver only','RUVSeq only'))
#contrast.plot.tot$Contrast = 'ks_alone'
#contrast.plot.tot$Contrast = 'CD4_group'
contrast.plot.tot$Contrast = contrast


# Create the comparison dot plot data
contrast.plot.tot$Contrast = as.factor(contrast.plot.tot$Contrast)
contrast.plot.tot$Method = factor(contrast.plot.tot$Method,
                             levels = c('Both','nSolver only','RUVSeq only'))
contrast.plot.tot = contrast.plot.tot[order(contrast.plot.tot$Method,decreasing = T),]

```

## Create the plot for comparing fold change between analysis methods

```{r fold_change_comparison_plot, message=FALSE, warning=FALSE}
fc.plot = ggplot(data = contrast.plot.tot,
                 aes(x = RUVFC, y = nSolverFC, color = Method)) + geom_point(aes(size = RUVSE)) +
  scale_color_manual(values = c("#4DAF4A","#377EB8","#E41A1C")) + 
  geom_hline(yintercept = 0,linetype = 2) +
  geom_vline(xintercept = 0,linetype = 2) +  theme_minimal() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=24),
        plot.title = element_text(size = 30),
        legend.title=element_text(size=20),
        legend.text=element_text(size=20),
        strip.text = element_text(size=24),
        panel.spacing=unit(1, "lines"),
        panel.border = element_rect(color = "grey", 
                                    fill = NA, size = .1),
        legend.position = 'bottom') + facet_wrap(~Contrast) +
  xlab('Log-fold change (RUVSeq)') + ylab('Log-fold change (nSolver)') +
  labs(size = 'SE (RUVSeq)') + geom_abline(slope = 1,intercept = 0,linetype = 2, color='grey') +
  guides(colour = guide_legend(override.aes = list(size=4)))

print(fc.plot)

# Export the plot, if desired
export_fc_plot <- TRUE
if(export_fc_plot == TRUE){
  ggsave(paste0("Results/QC/foldchange_plot_",contrast,".pdf"), plot = fc.plot)
}

```
